{% extends 'tennis_base.html' %}

{% block head %}
<title>{{ user_name }}'s Tennis Log</title>
{% endblock %}

{% block body %}
<div class="content">
    {% block first_part %}
    {% endblock %}

    <style>
        .set_score {
            width:50px;
        }
    </style>

    <div class="form">
        <form action="{% block form_action %}{% endblock %}?u={{ u }}" method="POST">
            <table>
                <tr style="background-color: lightgrey;">
                    <td>Date:</td>
                    <td><input type="text" name="date" id="date" value="{% block form_date %}{% endblock %}"></td>
                </tr>
                <tr>
                    <td class="user_input">Duration in minutes:</td>
                    <td><input type="text" name="duration" id="duration" value="{% block form_duration %}{% endblock %}" inputmode="numeric"></td>
                </tr>
                <tr>
                    <td class="user_input">Location:</td>
                    <td><input type="text" name="location" id="location" value="{% block form_location %}{% endblock %}"></td>
                </tr>
                <tr>
                    <td class="user_input">Category:</td>
                    <td>
                        <input type="text" name="category" id="category" value="{% block form_category %}{% endblock %}">
                    </td>
                </tr>
                <tr>
                    <td class="user_input">Details:</td>
                    <td><input type="text" name="details" id="details" value="{% block form_details %}{% endblock %}"></td>
                </tr>
                <tr id="match-details-row" style="display: none;">
                    <td colspan="2">
                        <div>
                            <label><input type="radio" name="match_type" value="singles" checked> Singles</label>
                            <label><input type="radio" name="match_type" value="doubles"> Doubles</label>
                        </div>
                        <div class="match-details">
                            <div>Team 1: </div>
                            <div><input type="text" name="player1" id="player1"></div>
                            <div id="team1_doubles" style="display: none;"><input type="text" name="player3" id="player3"></div>
                            <div>Team 2: </div>
                            <div><input type="text" name="player2" id="player2"></div>
                            <div id="team2_doubles" style="display: none;"><input type="text" name="player4" id="player4"></div>
                        </div>
                        <div class="set-scores">
                            <table>
                                <tr id="team1_score">
                                    <td>Team 1</td>
                                    <td>
                                        <input type="text" name="team1_set1" placeholder="Set 1" class="set_score" tabindex="1" size="1" maxlength="1">
                                        <input type="text" name="tiebreak_team1_set1" class="tiebreak_score" style="display: none;" size="2" maxlength="2">
                                    </td>
                                    <td>
                                        <input type="text" name="team1_set2" placeholder="Set 2" class="set_score" tabindex="3"size="1" maxlength="1">
                                        <input type="text" name="tiebreak_team1_set2" class="tiebreak_score" style="display: none;" size="2" maxlength="2">
                                    </td>
                                    <td>
                                        <input type="text" name="team1_set3" placeholder="Set 3" class="set_score" tabindex="5"size="1" maxlength="1">
                                        <input type="text" name="tiebreak_team1_set3" class="tiebreak_score" style="display: none;" size="2" maxlength="2">
                                    </td>
                                </tr>
                                <tr id="team2_score">
                                    <td>Team 2</td>
                                    <td>
                                        <input type="text" name="team2_set1" placeholder="Set 1" class="set_score" tabindex="2"size="1" maxlength="1">
                                        <input type="text" name="tiebreak_team2_set1" class="tiebreak_score" style="display: none;" size="2" maxlength="2">
                                    </td>
                                    <td>
                                        <input type="text" name="team2_set2" placeholder="Set 2" class="set_score" tabindex="4"size="1" maxlength="1">
                                        <input type="text" name="tiebreak_team2_set2" class="tiebreak_score" style="display: none;" size="2" maxlength="2">
                                    </td>
                                    <td>
                                        <input type="text" name="team2_set3" placeholder="Set 3" class="set_score" tabindex="6"size="1" maxlength="1">
                                        <input type="text" name="tiebreak_team2_set3" class="tiebreak_score" style="display: none;" size="2" maxlength="2">
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="match-outcome">
                            Match Won: 
                                <label><input type="radio" name="match_outcome" value="team1_won" checked> Team 1</label>
                                <label><input type="radio" name="match_outcome" value="team2_won"> Team 2</label>
                            
                        </div>
                        <div class="match-description">
                            <label>Match Description: <textarea name="match_description" id="match_description"></textarea></label>
                        </div>
                    </td>
                </tr>
            </table>
            <br>
            <div class="container">
                <input class="iphone-button" type="submit" value="Submit">
            </div>
        </form>
    </div>    
</div>

<script>
    // Get today's date
    var today = new Date();
    
    // Format the date as YYYY-MM-DD
    var formattedDate = today.getFullYear() + '-' + (today.getMonth() + 1).toString().padStart(2, '0') + '-' + today.getDate().toString().padStart(2, '0');
    
    // Set the value of the input field with today's date
    if (!document.getElementById('date').value) {
        document.getElementById('date').value = formattedDate;
    }
</script>

<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script>
    function toggleMatchDetails(selectedValue) {
        var matchDetailsRow = document.getElementById('match-details-row');

        if (selectedValue?.toLowerCase() === 'match') {
            matchDetailsRow.style.display = 'table-row';
        } else {
            matchDetailsRow.style.display = 'none';
        }
    }

    $(document).ready(function() {
        $('#category').on('focus', function() {
            $(this).autocomplete('search', '');
        });
        $('#category').autocomplete({
            source: function(request, response) {
                $.ajax({
                    url: '/categories',
                    dataType: 'json',
                    data: {
                        term: request.term
                    },
                    success: function(data) {
                        response(data);
                    }
                });
            },
            minLength: 0, // Minimum characters before triggering autocomplete
            select: function(event, ui) {
                $('#category').val(ui.item.value); // Update input value when an option is selected
                toggleMatchDetails(ui.item.value);
                return false; // Prevent default behavior of input field
            }
        });

        function checkScores() {
            for (let i = 1; i <= 3; i++) {
                let team1_set = parseInt($(`input[name="team1_set${i}"]`).val()) || 0;
                let team2_set = parseInt($(`input[name="team2_set${i}"]`).val()) || 0;
                let scoreDifference = Math.abs(team1_set - team2_set);
                
                if (scoreDifference === 1) {
                    $(`input[name="tiebreak_team1_set${i}"]`).show();
                    $(`input[name="tiebreak_team2_set${i}"]`).show();
                } else {
                    $(`input[name="tiebreak_team1_set${i}"]`).hide().val('');
                    $(`input[name="tiebreak_team2_set${i}"]`).hide().val('');
                }
            }
        }

        $('.set_score').on('input', checkScores);

        function calculateMatchOutcome() {
            let team1_sets_won = 0;
            let team2_sets_won = 0;

            for (let i = 1; i <= 3; i++) {
                let team1_set_score = parseInt($(`input[name="team1_set${i}"]`).val()) || 0;
                let team2_set_score = parseInt($(`input[name="team2_set${i}"]`).val()) || 0;

                if (team1_set_score > team2_set_score) {
                    team1_sets_won++;
                } else if (team2_set_score > team1_set_score) {
                    team2_sets_won++;
                }
            }

            if (team1_sets_won > team2_sets_won || (team1_sets_won === 2 && team2_sets_won < 2)) {
                $('input[name="match_outcome"][value="team1_won"]').prop('checked', true);
                $('#team1_score').css('background-color', 'lightgreen');
                $('#team2_score').css('background-color', ''); // Reset Team 2's background color
            } else {
                $('input[name="match_outcome"][value="team2_won"]').prop('checked', true);
                $('#team2_score').css('background-color', 'lightgreen');
                $('#team1_score').css('background-color', ''); // Reset Team 1's background color
            }
        }

        $('.set_score').on('input', calculateMatchOutcome);
    });

    $(document).ready(function() {
        // Hardcoded array of locations
        var locations = [
            "CP",
            "RHS",
            "RMS",
            "WSC"
        ];

        $('#location').on('focus', function() {
            $(this).autocomplete('search', '');
        });

        $('#location').autocomplete({
            source: locations, // Use the hardcoded array
            minLength: 0, // Minimum characters before triggering autocomplete
            select: function(event, ui) {
                $('#location').val(ui.item.value); // Update input value when an option is selected
                return false; // Prevent default behavior of input field
            }
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        var team1_doubles= document.getElementById('team1_doubles');
        var team2_doubles = document.getElementById('team2_doubles');
        var matchTypeRadios = document.getElementsByName('match_type');

        function toggleMatchType() {
            if (document.querySelector('input[name="match_type"]:checked').value === 'singles') {
                team1_doubles.style.display = 'none';
                team2_doubles.style.display = 'none';
            } else {
                team1_doubles.style.display = 'block';
                team2_doubles.style.display = 'block';
            }
        }

        // Initialize the visibility on page load
        toggleMatchType();

        // Add event listeners for match type radios
        matchTypeRadios.forEach(function(radio) {
            radio.addEventListener('change', toggleMatchType);
        });
    });
</script>

    {% block bottom_part %}
    {% endblock %}

{% endblock %}